%%%===================================================================
%%% @author Mathieu Kerjouan
%%% @copyright 2018 (c) Mathieu Kerjouan
%%% @version 0.1.0
%%% @title zfs_stream drr_object data structure 
%%% @doc 
%%% @end
%%%===================================================================
-module(drr_object).
-export([struct/0]).
-export([parse/1, parse/2]).
-include("zfs_drr.hrl").
-include_lib("eunit/include/eunit.hrl").

%%--------------------------------------------------------------------
%% @doc
%% @end
%%--------------------------------------------------------------------
-spec struct() -> list().
struct() ->
    [drr_type, drr_bonustype, drr_blksz
    ,drr_bonuslen, drr_checksumtype, drr_compress
    ,{drr_pad, parse, [6]}
    ,drr_toguid].

%%--------------------------------------------------------------------
%% @doc
%% @end
%%--------------------------------------------------------------------
-spec parse(bitstring()) -> {ok, map(), bitstring()}.
parse(Bitstring) ->
    parse(Bitstring, []).

%%--------------------------------------------------------------------
%% @doc
%% @end
%%--------------------------------------------------------------------
-spec parse(bitstring(), list()) -> {ok, map(), bitstring()}.
parse(<<DRR_OBJECT:?DRR_OBJECT_SIZE/bitstring, Bitstring/bitstring>>
     ,_Opts) ->
    struct_parser:do(Bitstring, struct()).

%%--------------------------------------------------------------------
%% @doc
%% @end
%%--------------------------------------------------------------------
parse_0001_test() ->
    % 5bcec4573/3655670126f/13892301ff29f/52b5419a4fbe1c
    _IN = <<1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,21,0,0 
	    ,0,0,0,0,0,0,4,0,0,0,0,0,0,0,0,0,0,0,0
	    ,0,0,54,80,15,33,249,114,233,135,0,0,0
	    ,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
	    ,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
	    ,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
	    ,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
	    ,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
	    ,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
	    ,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
	    ,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
	    ,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
	    ,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
	    ,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
	    ,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0
	    ,0,115,69,236,188,5,0,0,0,111,18,112,86
	    ,101,3,0
	    ,0,159,242,31, 48,146,56,1,0
	    ,28,190,79,154, 65,181,82,0>>,
    _OUT = {ok, #{ drr_type => master_node
		 , bonustype => none
		 , blksz => 512
		 , bonuslen => 0
		 , checksumtype => '_'
		 , compress => '_' 
		 , pad => '_'
		 , toguid => '_' }, 
	    <<>>}.
